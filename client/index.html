<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Issue System</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Navigation -->
  <nav class="bg-blue-600 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">Book Issue System</h1>
      <div id="nav-links">
        <button id="home-btn" class="px-4 py-2 hover:bg-blue-700 rounded">Home</button>
        <button id="admin-login-btn" class="px-4 py-2 hover:bg-blue-700 rounded">Admin Login</button>
        <button id="feedback-btn" class="px-4 py-2 hover:bg-blue-700 rounded">Submit Feedback</button>
        <button id="logout-btn" class="px-4 py-2 hover:bg-blue-700 rounded hidden">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div id="content" class="container mx-auto p-6"></div>

  <script>
    // API Base URL
    const API_BASE_URL = 'https://book-issue.onrender.com/api';

    // Utility to get token from localStorage
    const getToken = () => localStorage.getItem('token');

    // Utility to set token
    const setToken = (token) => localStorage.setItem('token', token);

    // Utility to clear token
    const clearToken = () => localStorage.removeItem('token');

    // Utility to check if admin is logged in
    const isLoggedIn = () => !!getToken();

    // Utility to fetch with token
    async function fetchWithAuth(url, options = {}) {
      const token = getToken();
      const headers = {
        'Content-Type': 'application/json',
        ...(token ? { 'x-auth-token': token } : {}),
      };
      try {
        const response = await fetch(`${API_BASE_URL}${url}`, {
          ...options,
          headers,
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.msg || 'Request failed');
        }
        return response.json();
      } catch (error) {
        throw error;
      }
    }

    // Navigation Handler
    function navigateTo(page) {
      const content = document.getElementById('content');
      const logoutBtn = document.getElementById('logout-btn');
      logoutBtn.classList.toggle('hidden', !isLoggedIn());

      switch (page) {
        case 'home':
          renderStudentForm();
          break;
        case 'admin-login':
          renderAdminLogin();
          break;
        case 'admin-dashboard':
          renderAdminDashboard();
          break;
        case 'feedback':
          renderFeedbackForm();
          break;
        case 'feedback-list':
          renderFeedbackList();
          break;
        default:
          renderStudentForm();
      }
    }

    // Render Student Form
    function renderStudentForm() {
      document.getElementById('content').innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
          <h2 class="text-2xl font-bold mb-4 text-center">Student Form</h2>
          <form id="student-form" enctype="multipart/form-data" class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Full Name</label>
              <input type="text" name="fullName" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Father's Name</label>
              <input type="text" name="fatherName" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Mobile Number</label>
              <input type="text" name="mobileNo" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Email</label>
              <input type="email" name="email" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Address</label>
              <input type="text" name="address" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Landmark</label>
              <input type="text" name="landmark" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">City</label>
              <input type="text" name="city" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">State</label>
              <input type="text" name="state" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Country</label>
              <input type="text" name="country" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Pincode</label>
              <input type="text" name="pincode" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Date of Birth</label>
              <input type="date" name="dob" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Current Standard</label>
              <input type="text" name="runningStandard" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Previous Standard</label>
              <input type="text" name="previousStandard" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">School Name</label>
              <input type="text" name="schoolName" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Books Requested</label>
              <input type="number" name="booksRequested" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Result (PDF/JPG/PNG)</label>
              <input type="file" name="result" accept=".pdf,.jpg,.jpeg,.png" required class="w-full p-2 border rounded">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Submit</button>
          </form>
          <p id="student-form-error" class="text-red-500 mt-2 hidden"></p>
          <p id="student-form-success" class="text-green-500 mt-2 hidden"></p>
        </div>
      `;

      document.getElementById('student-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const errorEl = document.getElementById('student-form-error');
        const successEl = document.getElementById('student-form-success');

        try {
          const response = await fetch(`${API_BASE_URL}/student/submit`, {
            method: 'POST',
            body: formData,
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.msg || 'Submission failed');
          successEl.textContent = `Form submitted successfully! Student ID: ${data.studentId}`;
          successEl.classList.remove('hidden');
          errorEl.classList.add('hidden');
          e.target.reset();
        } catch (error) {
          errorEl.textContent = error.message;
          errorEl.classList.remove('hidden');
          successEl.classList.add('hidden');
        }
      });
    }

    // Render Admin Login
    function renderAdminLogin() {
      document.getElementById('content').innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
          <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
          <form id="admin-login-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Username</label>
              <input type="text" name="username" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Password</label>
              <input type="password" name="password" required class="w-full p-2 border rounded">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Login</button>
          </form>
          <p id="admin-login-error" class="text-red-500 mt-2 hidden"></p>
        </div>
      `;

      document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target));
        const errorEl = document.getElementById('admin-login-error');

        try {
          const data = await fetchWithAuth('/admin/login', {
            method: 'POST',
            body: JSON.stringify(formData),
          });
          setToken(data.token);
          errorEl.classList.add('hidden');
          navigateTo('admin-dashboard');
        } catch (error) {
          errorEl.textContent = error.message;
          errorEl.classList.remove('hidden');
        }
      });
    }

    // Render Admin Dashboard
    async function renderAdminDashboard() {
      if (!isLoggedIn()) {
        navigateTo('admin-login');
        return;
      }

      try {
        const requests = await fetchWithAuth('/admin/requests');
        const feedbacks = await fetchWithAuth('/feedback/feedback');

        document.getElementById('content').innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-2">Update Profile</h3>
              <form id="admin-profile-form" class="space-y-4 max-w-md">
                <div>
                  <label class="block text-sm font-medium">New Username</label>
                  <input type="text" name="username" class="w-full p-2 border rounded">
                </div>
                <div>
                  <label class="block text-sm font-medium">New Password</label>
                  <input type="password" name="password" class="w-full p-2 border rounded">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Update Profile</button>
              </form>
              <p id="admin-profile-error" class="text-red-500 mt-2 hidden"></p>
              <p id="admin-profile-success" class="text-green-500 mt-2 hidden"></p>
            </div>
            <h3 class="text-xl font-semibold mb-2">Pending Student Requests</h3>
            <div id="requests-list" class="space-y-4">
              ${requests.length === 0 ? '<p>No pending requests</p>' : requests.map(student => `
                <div class="border p-4 rounded flex justify-between items-center">
                  <div>
                    <p><strong>Name:</strong> ${student.fullName}</p>
                    <p><strong>Email:</strong> ${student.email}</p>
                    <p><strong>Books Requested:</strong> ${student.booksRequested}</p>
                    <p><strong>Result:</strong> <a href="${student.resultUrl}" target="_blank" class="text-blue-600">View</a></p>
                  </div>
                  <div class="space-x-2">
                    <button onclick="handleRequestAction('${student._id}', 'approve')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Approve</button>
                    <button onclick="handleRequestAction('${student._id}', 'reject')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Reject</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <h3 class="text-xl font-semibold mt-8 mb-2">Feedback</h3>
            <button onclick="navigateTo('feedback-list')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">View All Feedback</button>
          </div>
        `;

        document.getElementById('admin-profile-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = Object.fromEntries(new FormData(e.target));
          const errorEl = document.getElementById('admin-profile-error');
          const successEl = document.getElementById('admin-profile-success');

          try {
            const data = await fetchWithAuth('/admin/update-profile', {
              method: 'PUT',
              body: JSON.stringify(formData),
            });
            successEl.textContent = data.msg;
            successEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            e.target.reset();
          } catch (error) {
            errorEl.textContent = error.message;
            errorEl.classList.remove('hidden');
            successEl.classList.add('hidden');
          }
        });
      } catch (error) {
        document.getElementById('content').innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-md text-center">
            <p class="text-red-500">${error.message}</p>
            <button onclick="navigateTo('admin-login')" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Back to Login</button>
          </div>
        `;
      }
    }

    // Handle Approve/Reject Actions
    async function handleRequestAction(studentId, action) {
      try {
        await fetchWithAuth(`/admin/${action}/${studentId}`, { method: 'PUT' });
        alert(`Request ${action}d successfully`);
        navigateTo('admin-dashboard');
      } catch (error) {
        alert(error.message);
      }
    }

    // Render Feedback Form
    function renderFeedbackForm() {
      const urlParams = new URLSearchParams(window.location.search);
      const studentId = urlParams.get('studentId') || '';

      document.getElementById('content').innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
          <h2 class="text-2xl font-bold mb-4 text-center">Submit Feedback</h2>
          <form id="feedback-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Student ID</label>
              <input type="text" name="studentId" value="${studentId}" required class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium">Feedback</label>
              <textarea name="feedback" required class="w-full p-2 border rounded" rows="4"></textarea>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Submit</button>
          </form>
          <p id="feedback-form-error" class="text-red-500 mt-2 hidden"></p>
          <p id="feedback-form-success" class="text-green-500 mt-2 hidden"></p>
        </div>
      `;

      document.getElementById('feedback-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target));
        const errorEl = document.getElementById('feedback-form-error');
        const successEl = document.getElementById('feedback-form-success');

        try {
          const data = await fetchWithAuth('/feedback/submit', {
            method: 'POST',
            body: JSON.stringify(formData),
          });
          successEl.textContent = data.msg;
          successEl.classList.remove('hidden');
          errorEl.classList.add('hidden');
          e.target.reset();
        } catch (error) {
          errorEl.textContent = error.message;
          errorEl.classList.remove('hidden');
          successEl.classList.add('hidden');
        }
      });
    }

    // Render Feedback List
    async function renderFeedbackList() {
      if (!isLoggedIn()) {
        navigateTo('admin-login');
        return;
      }

      try {
        const feedbacks = await fetchWithAuth('/feedback/feedback');
        document.getElementById('content').innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Feedback List</h2>
            <div class="space-y-4">
              ${feedbacks.length === 0 ? '<p>No feedback available</p>' : feedbacks.map(feedback => `
                <div class="border p-4 rounded">
                  <p><strong>Student:</strong> ${feedback.studentId?.fullName || 'Unknown'}</p>
                  <p><strong>Email:</strong> ${feedback.studentId?.email || 'Unknown'}</p>
                  <p><strong>Feedback:</strong> ${feedback.feedback}</p>
                  <p><strong>Date:</strong> ${new Date(feedback.createdAt).toLocaleString()}</p>
                </div>
              `).join('')}
            </div>
            <button onclick="navigateTo('admin-dashboard')" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Back to Dashboard</button>
          </div>
        `;
      } catch (error) {
        document.getElementById('content').innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-md text-center">
            <p class="text-red-500">${error.message}</p>
            <button onclick="navigateTo('admin-login')" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Back to Login</button>
          </div>
        `;
      }
    }

    // Event Listeners for Navigation
    document.getElementById('home-btn').addEventListener('click', () => navigateTo('home'));
    document.getElementById('admin-login-btn').addEventListener('click', () => navigateTo('admin-login'));
    document.getElementById('feedback-btn').addEventListener('click', () => navigateTo('feedback'));
    document.getElementById('logout-btn').addEventListener('click', () => {
      clearToken();
      navigateTo('home');
    });

    // Initial Render
    navigateTo('home');
  </script>
</body>
</html>